import json
import numpy as np
import pytest
import torch
from pathlib import Path

import torch
from ml.inference import TORCH
from ml.dataset import convert_input_to_tensor
from common.game import GameState
from ml.pc_remover import remove_path_condition_root
from torch_geometric.data import HeteroData


expected1 = HeteroData()

expected1['game_vertex'].x = torch.tensor([
    [1., 2., 1., 0., 0., 1., 1.],
    [1., 6., 1., 0., 1., 1., 1.],
    [1., 1., 1., 0., 0., 1., 1.],
    [1., 3., 1., 0., 0., 1., 1.],
    [1., 6., 1., 0., 1., 1., 1.],
    [1., 1., 1., 0., 0., 1., 1.],
    [1., 3., 1., 0., 0., 1., 1.],
    [1., 6., 1., 0., 1., 1., 1.],
    [1., 1., 1., 0., 0., 1., 1.],
    [1., 9., 1., 0., 0., 1., 1.],
    [1., 5., 1., 0., 0., 1., 1.],
    [1., 2., 1., 0., 0., 1., 1.],
    [1., 5., 1., 0., 0., 0., 1.],
    [1., 4., 1., 0., 0., 0., 1.],
    [1., 4., 1., 0., 0., 0., 1.],
    [1., 3., 1., 0., 0., 1., 1.],
    [1., 2., 1., 0., 0., 1., 1.]
])

expected1['state_vertex'].x = torch.tensor([
    [5., 0., 0., 0., 90., 31.],
    [4., 0., 0., 0., 83., 35.],
    [2., 0., 0., 0., 72., 29.],
    [2., 0., 0., 0., 87., 28.]
])

expected1['path_condition_vertex'].x = torch.tensor([
    [0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]
])

expected1[('game_vertex', 'to', 'game_vertex')].edge_index = torch.tensor([
    [0,  0,  1,  3,  3,  4,  6,  6,  7,  9, 10, 10, 12, 12, 13, 14, 15, 15],
    [1,  3,  2,  4,  6,  5,  7,  9,  8, 15, 11, 12, 13, 14, 15, 15, 16, 10]
])

expected1[('game_vertex', 'to', 'game_vertex')].edge_type = torch.tensor(
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
)

expected1[('state_vertex', 'in', 'game_vertex')].edge_index = torch.tensor([
    [0,  1,  2,  3],
    [10, 12, 16, 16]
])

expected1[('game_vertex', 'in', 'state_vertex')].edge_index = torch.tensor([
    [10, 12, 16, 16],
    [0,  1,  2,  3]
])

expected1[('state_vertex', 'history', 'game_vertex')].edge_index = torch.tensor([
    [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    [0, 3, 6, 9, 15, 10, 12, 13, 0, 3, 6, 9, 15, 10, 12, 14, 0, 3, 6, 9, 15, 10, 12, 14, 16, 0, 3, 6, 9, 15, 10, 12, 13, 16]
])

expected1[('state_vertex', 'history', 'game_vertex')].edge_attr = torch.tensor([
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 78], [2, 85], [1, 47], [1, 57],
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 65], [2, 69], [2, 77], [1, 58],
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 65], [1, 36], [1, 47], [1, 58], [1, 68],
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 78], [1, 36], [1, 47], [1, 57], [1, 84]
])

expected1[('game_vertex', 'history', 'state_vertex')].edge_index = torch.tensor([
    [0, 3, 6, 9, 15, 10, 12, 13, 0, 3, 6, 9, 15, 10, 12, 14, 0, 3, 6, 9, 15, 10, 12, 14, 16, 0, 3, 6, 9, 15, 10, 12, 13, 16],
    [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3]
])

expected1[('game_vertex', 'history', 'state_vertex')].edge_attr = torch.tensor([
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 78], [2, 85], [1, 47], [1, 57], 
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 65], [2, 69], [2, 77], [1, 58], 
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 65], [1, 36], [1, 47], [1, 58], [1, 68], 
    [1, 0], [1, 3], [1, 8], [1, 14], [2, 78], [1, 36], [1, 47], [1, 57], [1, 84]
])

expected1[('state_vertex', 'parent_of', 'state_vertex')].edge_index = torch.tensor([
    [2, 3, 3],
    [1, 2, 0]
])

expected1[('path_condition_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 10, 0, 1, 1, 3, 1, 2, 3, 8, 3, 4, 4, 6, 4, 5, 6, 9, 6, 7, 7, 8, 10, 3, 
     10, 11, 12, 13, 13, 15, 13, 14, 16, 17, 17, 19, 17, 18, 20, 8, 20, 9, 21, 
     8, 21, 3, 22, 23, 23, 8, 23, 11, 24, 25, 25, 8, 25, 9, 26, 19, 26, 18, 27, 
     26, 28, 29, 28, 9, 29, 30, 29, 3, 31, 28, 32, 21],
    [10, 0, 1, 0, 3, 1, 2, 1, 8, 3, 4, 3, 6, 4, 5, 4, 9, 6, 7, 6, 8, 7, 3, 10, 
     11, 10, 13, 12, 15, 13, 14, 13, 17, 16, 19, 17, 18, 17, 8, 20, 9, 20, 8, 
     21, 3, 21, 23, 22, 8, 23, 11, 23, 25, 24, 8, 25, 9, 25, 19, 26, 18, 26, 26, 
     27, 29, 28, 9, 28, 30, 29, 3, 29, 28, 31, 21, 32]
])

expected1[('path_condition_vertex', 'to', 'state_vertex')].edge_index = torch.tensor([
    [0, 12, 16, 20, 21, 22, 24, 26, 0, 12, 16, 20, 27, 28, 22, 24, 0, 12, 16, 20, 27, 31, 22, 24, 0, 12, 16, 20, 22, 24, 32, 26],
    [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3]
])

expected1[('state_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3],
    [0, 12, 16, 20, 21, 22, 24, 26, 0, 12, 16, 20, 27, 28, 22, 24, 0, 12, 16, 20, 27, 31, 22, 24, 0, 12, 16, 20, 22, 24, 32, 26]
])


expected2 = HeteroData()

expected2['game_vertex'].x = torch.tensor([
    [0., 2., 1., 0., 1., 0., 1.],
    [0., 1., 1., 0., 0., 0., 1.],
    [0., 2., 1., 0., 1., 0., 1.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 2., 0., 0., 1., 0., 0.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 1., 1., 0., 1., 0., 1.],
    [0., 20., 0., 0., 0., 0., 0.],
    [0., 3., 1., 0., 1., 0., 1.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 2., 1., 0., 1., 0., 1.],
    [0., 11., 1., 0., 0., 0., 1.],
    [0., 15., 1., 0., 0., 0., 1.],
    [0., 3., 1., 0., 0., 0., 1.],
    [0., 8., 1., 0., 1., 0., 1.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 4., 0., 0., 0., 0., 0.],
    [0., 8., 1., 0., 0., 0., 1.],
    [0., 4., 1., 0., 0., 0., 1.],
    [0., 10., 1., 0., 0., 0., 0.],
    [0., 8., 0., 0., 1., 0., 0.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 4., 0., 0., 0., 0., 0.],
    [0., 3., 0., 0., 0., 0., 0.],
    [0., 4., 0., 0., 1., 0., 0.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 27., 1., 0., 0., 0., 1.],
    [1., 2., 1., 0., 1., 0., 1.],
    [1., 9., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 0., 0., 0.],
    [1., 5., 0., 0., 1., 0., 0.],
    [1., 4., 0., 0., 1., 0., 0.],
    [1., 4., 0., 0., 1., 0., 0.],
    [1., 5., 0., 0., 1., 0., 0.],
    [1., 10., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 0., 0., 0.],
    [1., 4., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 0., 0., 0.]
])

expected2['state_vertex'].x = torch.tensor([
    [8., 0., 0., 0., 58., 24.],
    [17., 0., 0., 0., 61., 40.]
])

expected2['path_condition_vertex'].x = torch.tensor([
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
])

expected2[('game_vertex', 'to', 'game_vertex')].edge_index = torch.tensor([
    [0, 0, 1, 1, 2, 2, 3, 4, 5, 6, 6, 7, 8, 8, 9, 10, 10, 11, 12, 12, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 19, 20, 21, 21, 22, 23, 23, 24, 25, 26, 26, 27, 27, 28, 29, 29, 30, 31, 32, 33, 34, 35, 37],
    [1, 10, 2, 4, 3, 6, 15, 5, 15, 7, 26, 3, 9, 12, 28, 11, 26, 1, 13, 18, 17, 15, 0, 16, 18, 17, 18, 14, 19, 24, 23, 21, 22, 24, 23, 24, 20, 25, 9, 11, 7, 28, 8, 29, 30, 37, 31, 32, 33, 34, 35, 36, 38]
])

expected2[('game_vertex', 'to', 'game_vertex')].edge_type = torch.tensor(
    [0, 1, 0, 0, 0, 1, 2, 0, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
)

expected2[('state_vertex', 'in', 'game_vertex')].edge_index = torch.tensor([
    [0,  1],
    [19, 26]
])

expected2[('game_vertex', 'in', 'state_vertex')].edge_index = torch.tensor([
    [19, 26],
    [ 0,  1]
])

expected2[('state_vertex', 'history', 'game_vertex')].edge_index = torch.tensor([
    [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [27, 8, 12, 13, 17, 18, 19, 27, 8, 12, 13, 17, 14, 0, 10, 26, 11, 1, 2, 6]
])

expected2[('state_vertex', 'history', 'game_vertex')].edge_attr = torch.tensor([
    [1, 0], [1, 2], [1, 5], [1, 16], [1, 19], [1, 23], [1, 48], [1, 0], [1, 2], 
    [1, 5], [1, 16], [1, 19], [1, 24], [1, 29], [1, 31], [2, 55], [1, 42], [1, 50], [1, 51], [1, 54]
])

expected2[('game_vertex', 'history', 'state_vertex')].edge_index = torch.tensor([
    [27, 8, 12, 13, 17, 18, 19, 27, 8, 12, 13, 17, 14, 0, 10, 26, 11, 1, 2, 6],
    [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
])

expected2[('game_vertex', 'history', 'state_vertex')].edge_attr = torch.tensor([
    [1, 0], [1, 2], [1, 5], [1, 16], [1, 19], [1, 23], [1, 48], [1, 0], [1, 2], 
    [1, 5], [1, 16], [1, 19], [1, 24], [1, 29], [1, 31], [2, 55], [1, 42], [1, 50], [1, 51], [1, 54]
])

expected2[('state_vertex', 'parent_of', 'state_vertex')].edge_index = torch.tensor([
    [0],
    [1]
])

expected2[('path_condition_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 1, 1, 3, 1, 2, 4, 5, 5, 7, 5, 6, 8, 2, 8, 3],
    [1, 0, 3, 1, 2, 1, 5, 4, 7, 5, 6, 5, 2, 8, 3, 8]
])

expected2[('path_condition_vertex', 'to', 'state_vertex')].edge_index = torch.tensor([
    [0, 4, 1, 4, 8],
    [0, 0, 1, 1, 1]
])

expected2[('state_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 0, 1, 1, 1],
    [0, 4, 1, 4, 8]
])


expected3 = HeteroData()

expected3['game_vertex'].x = torch.tensor([
    [0., 2., 1., 0., 1., 0., 1.],
    [0., 1., 1., 0., 0., 0., 1.],
    [0., 2., 1., 0., 1., 0., 1.],
    [0., 1., 1., 0., 0., 0., 1.],
    [0., 2., 0., 0., 1., 0., 0.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 1., 1., 0., 1., 0., 1.],
    [0., 20., 1., 0., 0., 0., 1.],
    [0., 3., 1., 0., 1., 0., 1.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 2., 1., 0., 1., 0., 1.],
    [0., 11., 1., 0., 0., 0., 1.],
    [0., 15., 1., 0., 0., 0., 1.],
    [0., 3., 1., 0., 0., 0., 1.],
    [0., 8., 1., 0., 1., 0., 1.],
    [0., 1., 1., 0., 0., 0., 1.],
    [0., 4., 0., 0., 0., 0., 0.],
    [0., 8., 1., 0., 0., 0., 1.],
    [0., 4., 1., 0., 0., 0., 1.],
    [0., 10., 1., 0., 0., 0., 1.],
    [0., 8., 0., 0., 1., 0., 0.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 4., 0., 0., 0., 0., 0.],
    [0., 3., 1., 0., 0., 0., 1.],
    [0., 4., 1., 0., 1., 0., 0.],
    [0., 1., 0., 0., 0., 0., 0.],
    [0., 27., 1., 0., 0., 0., 1.],
    [1., 2., 1., 0., 1., 0., 1.],
    [1., 9., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 0., 0., 0.],
    [1., 5., 0., 0., 1., 0., 0.],
    [1., 4., 0., 0., 1., 0., 0.],
    [1., 4., 0., 0., 1., 0., 0.],
    [1., 5., 0., 0., 1., 0., 0.],
    [1., 10., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 0., 0., 0.],
    [1., 4., 0., 0., 1., 0., 0.],
    [1., 1., 0., 0., 0., 0., 0.]
])

expected3['state_vertex'].x = torch.tensor([
    [4., 0., 0., 0., 87., 57.],
    [1., 0., 0., 0., 88., 28.]
])

expected3['path_condition_vertex'].x = torch.tensor([
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
])

expected3[('game_vertex', 'to', 'game_vertex')].edge_index = torch.tensor([
    [0, 0, 1, 1, 2, 2, 3, 4, 5, 6, 6, 7, 8, 8, 9, 10, 10, 11, 12, 12, 13, 14, 14, 15, 15, 16, 17, 17, 18, 18, 19, 20, 21, 21, 22, 23, 23, 24, 25, 26, 26, 27, 27, 28, 29, 29, 30, 31, 32, 33, 34, 35, 37],
    [1, 10, 2, 4, 3, 6, 15, 5, 15, 7, 26, 3, 9, 12, 28, 11, 26, 1, 13, 18, 17, 15, 0, 16, 18, 17, 18, 14, 19, 24, 23, 21, 22, 24, 23, 24, 20, 25, 9, 11, 7, 28, 8, 29, 30, 37, 31, 32, 33, 34, 35, 36, 38]
])

expected3[('game_vertex', 'to', 'game_vertex')].edge_type = torch.tensor(
    [0, 1, 0, 0, 0, 1, 2, 0, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
)

expected3[('state_vertex', 'in', 'game_vertex')].edge_index = torch.tensor([
    [0,  1],
    [18, 24]
])

expected3[('game_vertex', 'in', 'state_vertex')].edge_index = torch.tensor([
    [18, 24],
    [ 0,  1]
])

expected3[('state_vertex', 'history', 'game_vertex')].edge_index = torch.tensor([
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [27, 8, 12, 13, 17, 14, 0, 10, 26, 11, 1, 2, 6, 7, 3, 15, 18, 27, 8, 12, 13, 17, 18, 19, 23, 24]
])

expected3[('state_vertex', 'history', 'game_vertex')].edge_attr = torch.tensor([
    [1, 0], [1, 2], [1, 5], [1, 16], [1, 19], [1, 24], [1, 29], [1, 31], [2, 55], 
    [1, 42], [1, 50], [1, 51], [1, 54], [1, 67], [1, 78], [1, 81], [1, 83], [1, 0], 
    [1, 2], [1, 5], [1, 16], [1, 19], [1, 23], [1, 48], [1, 80], [1, 88]
])

expected3[('game_vertex', 'history', 'state_vertex')].edge_index = torch.tensor([
    [27, 8, 12, 13, 17, 14, 0, 10, 26, 11, 1, 2, 6, 7, 3, 15, 18, 27, 8, 12, 13, 17, 18, 19, 23, 24],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1]
])

expected3[('game_vertex', 'history', 'state_vertex')].edge_attr = torch.tensor([
    [1, 0], [1, 2], [1, 5], [1, 16], [1, 19], [1, 24], [1, 29], [1, 31], [2, 55], 
    [1, 42], [1, 50], [1, 51], [1, 54], [1, 67], [1, 78], [1, 81], [1, 83], [1, 0], 
    [1, 2], [1, 5], [1, 16], [1, 19], [1, 23], [1, 48], [1, 80], [1, 88]
])

expected3[('state_vertex', 'parent_of', 'state_vertex')].edge_index = torch.tensor([
    [1],
    [0]
])

expected3[('path_condition_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 2, 0, 1, 3, 4, 4, 6, 4, 5, 7, 1, 7, 2, 8, 0],
    [2, 0, 1, 0, 4, 3, 6, 4, 5, 4, 1, 7, 2, 7, 0, 8]
])

expected3[('path_condition_vertex', 'to', 'state_vertex')].edge_index = torch.tensor([
    [0, 3, 7, 8, 3],
    [0, 0, 0, 1, 1]
])

expected3[('state_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 0, 0, 1, 1],
    [0, 3, 7, 8, 3]
])


expected4 = HeteroData()

expected4['game_vertex'].x = torch.tensor([
    [1., 9., 1., 0., 1., 0., 0.],
    [1., 4., 0., 0., 0., 0., 0.]
])

expected4['state_vertex'].x = torch.tensor([
    [1., 0., 0., 0., 0., 0.]
])

expected4['path_condition_vertex'].x = torch.tensor([
    [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
])

expected4[('game_vertex', 'to', 'game_vertex')].edge_index = torch.tensor([
    [0],
    [1]
])

expected4[('game_vertex', 'to', 'game_vertex')].edge_type = torch.tensor(
    [0]
)

expected4[('state_vertex', 'in', 'game_vertex')].edge_index = torch.tensor([
    [0],
    [0]
])

expected4[('game_vertex', 'in', 'state_vertex')].edge_index = torch.tensor([
    [0],
    [0]
])

expected4[('state_vertex', 'history', 'game_vertex')].edge_index = torch.tensor([
    [0],
    [0]
])

expected4[('state_vertex', 'history', 'game_vertex')].edge_attr = torch.tensor([
    [1, 0]
])

expected4[('game_vertex', 'history', 'state_vertex')].edge_index = torch.tensor([
    [0],
    [0]
])

expected4[('game_vertex', 'history', 'state_vertex')].edge_attr = torch.tensor([
    [1, 0]
])

expected4[('state_vertex', 'parent_of', 'state_vertex')].edge_index = torch.empty((2, 0), dtype=torch.long)

expected4[('path_condition_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0, 1, 1, 3, 1, 2],
    [1, 0, 3, 1, 2, 1]
])

expected4[('path_condition_vertex', 'to', 'state_vertex')].edge_index = torch.tensor([
    [0],
    [0]
])

expected4[('state_vertex', 'to', 'path_condition_vertex')].edge_index = torch.tensor([
    [0],
    [0]
])


def get_heterodata_from_json(path: Path):
    with open(path, 'r') as f:
        json1 = json.load(f)
    game_state = GameState.from_dict(json1)
    heterodata, state_map = convert_input_to_tensor(game_state)
    return heterodata


class EdgeTypes:
    g_t_g = ('game_vertex', 'to', 'game_vertex')
    s_i_g = ('state_vertex', 'in', 'game_vertex')
    g_i_s = ('game_vertex', 'in', 'state_vertex')
    s_h_g = ('state_vertex', 'history', 'game_vertex')
    g_h_s = ('game_vertex', 'history', 'state_vertex')
    s_p_s = ('state_vertex', 'parent_of', 'state_vertex')
    p_t_p = ('path_condition_vertex', 'to', 'path_condition_vertex')
    p_t_s = ('path_condition_vertex', 'to', 'state_vertex')
    s_t_p = ('state_vertex', 'to', 'path_condition_vertex')
    

@pytest.fixture
def test_data():
    json_data_1 = Path("C:\\Users\\dvtit\\Desktop\\PySymGym\\resources\\onnx\\reference_gamestates\\86_gameState.json")
    json_data_2 = Path("C:\\Users\\dvtit\\Desktop\\PySymGym\\resources\\onnx\\reference_gamestates\\4009_gameState.json")
    json_data_3 = Path("C:\\Users\\dvtit\\Desktop\\PySymGym\\resources\\onnx\\reference_gamestates\\4036_gameState.json")
    json_data_4 = Path("C:\\Users\\dvtit\\Desktop\\PySymGym\\resources\\onnx\\reference_gamestates\\4781_gameState.json")
    
    heterodata1 = get_heterodata_from_json(json_data_1)
    heterodata2 = get_heterodata_from_json(json_data_2)
    heterodata3 = get_heterodata_from_json(json_data_3)
    heterodata4 = get_heterodata_from_json(json_data_4)
    
    return [
        (remove_path_condition_root(heterodata1), expected1),
        (remove_path_condition_root(heterodata2), expected2),
        (remove_path_condition_root(heterodata3), expected3),
        (remove_path_condition_root(heterodata4), expected4),
    ]

def test_compare_all(test_data):
    for result, expected in test_data:
        assert torch.equal(result[TORCH.game_vertex].x, expected[TORCH.game_vertex].x)
        assert torch.equal(result[TORCH.state_vertex].x, expected[TORCH.state_vertex].x)
        assert torch.equal(result[TORCH.path_condition_vertex].x, expected[TORCH.path_condition_vertex].x)
        assert torch.equal(result[EdgeTypes.g_t_g].edge_index, expected[EdgeTypes.g_t_g].edge_index)
        assert torch.equal(result[EdgeTypes.g_t_g].edge_type, expected[EdgeTypes.g_t_g].edge_type)
        assert torch.equal(result[EdgeTypes.s_i_g].edge_index, expected[EdgeTypes.s_i_g].edge_index)
        assert torch.equal(result[EdgeTypes.g_i_s].edge_index, expected[EdgeTypes.g_i_s].edge_index)
        assert torch.equal(result[EdgeTypes.s_h_g].edge_index, expected[EdgeTypes.s_h_g].edge_index)
        assert torch.equal(result[EdgeTypes.s_h_g].edge_attr, expected[EdgeTypes.s_h_g].edge_attr)
        assert torch.equal(result[EdgeTypes.g_h_s].edge_index, expected[EdgeTypes.g_h_s].edge_index)
        assert torch.equal(result[EdgeTypes.g_h_s].edge_attr, expected[EdgeTypes.g_h_s].edge_attr)
        assert torch.equal(result[EdgeTypes.s_p_s].edge_index, expected[EdgeTypes.s_p_s].edge_index)
        assert torch.equal(result[EdgeTypes.p_t_p].edge_index, expected[EdgeTypes.p_t_p].edge_index)
        assert torch.equal(result[EdgeTypes.p_t_s].edge_index, expected[EdgeTypes.p_t_s].edge_index)
        assert torch.equal(result[EdgeTypes.s_t_p].edge_index, expected[EdgeTypes.s_t_p].edge_index)

def test_non_all_features_are_zeros(test_data):
    for result, _ in test_data:
        for vector in result[TORCH.game_vertex].x.detach().cpu().numpy():
            assert not np.all(vector == 0)
            